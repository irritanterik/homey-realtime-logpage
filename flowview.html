<html>
<head>
  <title>Flow Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="config.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>
  <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
  <script>!function(a,b,c,d){"use strict";var e="treeview",f={};f.settings={injectStyle:!0,levels:2,expandIcon:"glyphicon glyphicon-plus",collapseIcon:"glyphicon glyphicon-minus",emptyIcon:"glyphicon",nodeIcon:"",selectedIcon:"",checkedIcon:"glyphicon glyphicon-check",uncheckedIcon:"glyphicon glyphicon-unchecked",color:d,backColor:d,borderColor:d,onhoverColor:"#F5F5F5",selectedColor:"#FFFFFF",selectedBackColor:"#428bca",searchResultColor:"#D9534F",searchResultBackColor:d,enableLinks:!1,highlightSelected:!0,highlightSearchResults:!0,showBorder:!0,showIcon:!0,showCheckbox:!1,showTags:!1,multiSelect:!1,onNodeChecked:d,onNodeCollapsed:d,onNodeDisabled:d,onNodeEnabled:d,onNodeExpanded:d,onNodeSelected:d,onNodeUnchecked:d,onNodeUnselected:d,onSearchComplete:d,onSearchCleared:d},f.options={silent:!1,ignoreChildren:!1},f.searchOptions={ignoreCase:!0,exactMatch:!1,revealResults:!0};var g=function(b,c){return this.$element=a(b),this.elementId=b.id,this.styleId=this.elementId+"-style",this.init(c),{options:this.options,init:a.proxy(this.init,this),remove:a.proxy(this.remove,this),getNode:a.proxy(this.getNode,this),getParent:a.proxy(this.getParent,this),getSiblings:a.proxy(this.getSiblings,this),getSelected:a.proxy(this.getSelected,this),getUnselected:a.proxy(this.getUnselected,this),getExpanded:a.proxy(this.getExpanded,this),getCollapsed:a.proxy(this.getCollapsed,this),getChecked:a.proxy(this.getChecked,this),getUnchecked:a.proxy(this.getUnchecked,this),getDisabled:a.proxy(this.getDisabled,this),getEnabled:a.proxy(this.getEnabled,this),selectNode:a.proxy(this.selectNode,this),unselectNode:a.proxy(this.unselectNode,this),toggleNodeSelected:a.proxy(this.toggleNodeSelected,this),collapseAll:a.proxy(this.collapseAll,this),collapseNode:a.proxy(this.collapseNode,this),expandAll:a.proxy(this.expandAll,this),expandNode:a.proxy(this.expandNode,this),toggleNodeExpanded:a.proxy(this.toggleNodeExpanded,this),revealNode:a.proxy(this.revealNode,this),checkAll:a.proxy(this.checkAll,this),checkNode:a.proxy(this.checkNode,this),uncheckAll:a.proxy(this.uncheckAll,this),uncheckNode:a.proxy(this.uncheckNode,this),toggleNodeChecked:a.proxy(this.toggleNodeChecked,this),disableAll:a.proxy(this.disableAll,this),disableNode:a.proxy(this.disableNode,this),enableAll:a.proxy(this.enableAll,this),enableNode:a.proxy(this.enableNode,this),toggleNodeDisabled:a.proxy(this.toggleNodeDisabled,this),search:a.proxy(this.search,this),clearSearch:a.proxy(this.clearSearch,this)}};g.prototype.init=function(b){this.tree=[],this.nodes=[],b.data&&("string"==typeof b.data&&(b.data=a.parseJSON(b.data)),this.tree=a.extend(!0,[],b.data),delete b.data),this.options=a.extend({},f.settings,b),this.destroy(),this.subscribeEvents(),this.setInitialStates({nodes:this.tree},0),this.render()},g.prototype.remove=function(){this.destroy(),a.removeData(this,e),a("#"+this.styleId).remove()},g.prototype.destroy=function(){this.initialized&&(this.$wrapper.remove(),this.$wrapper=null,this.unsubscribeEvents(),this.initialized=!1)},g.prototype.unsubscribeEvents=function(){this.$element.off("click"),this.$element.off("nodeChecked"),this.$element.off("nodeCollapsed"),this.$element.off("nodeDisabled"),this.$element.off("nodeEnabled"),this.$element.off("nodeExpanded"),this.$element.off("nodeSelected"),this.$element.off("nodeUnchecked"),this.$element.off("nodeUnselected"),this.$element.off("searchComplete"),this.$element.off("searchCleared")},g.prototype.subscribeEvents=function(){this.unsubscribeEvents(),this.$element.on("click",a.proxy(this.clickHandler,this)),"function"==typeof this.options.onNodeChecked&&this.$element.on("nodeChecked",this.options.onNodeChecked),"function"==typeof this.options.onNodeCollapsed&&this.$element.on("nodeCollapsed",this.options.onNodeCollapsed),"function"==typeof this.options.onNodeDisabled&&this.$element.on("nodeDisabled",this.options.onNodeDisabled),"function"==typeof this.options.onNodeEnabled&&this.$element.on("nodeEnabled",this.options.onNodeEnabled),"function"==typeof this.options.onNodeExpanded&&this.$element.on("nodeExpanded",this.options.onNodeExpanded),"function"==typeof this.options.onNodeSelected&&this.$element.on("nodeSelected",this.options.onNodeSelected),"function"==typeof this.options.onNodeUnchecked&&this.$element.on("nodeUnchecked",this.options.onNodeUnchecked),"function"==typeof this.options.onNodeUnselected&&this.$element.on("nodeUnselected",this.options.onNodeUnselected),"function"==typeof this.options.onSearchComplete&&this.$element.on("searchComplete",this.options.onSearchComplete),"function"==typeof this.options.onSearchCleared&&this.$element.on("searchCleared",this.options.onSearchCleared)},g.prototype.setInitialStates=function(b,c){if(b.nodes){c+=1;var d=b,e=this;a.each(b.nodes,function(b,f){f.nodeId=e.nodes.length,f.parentId=d.nodeId,f.hasOwnProperty("selectable")||(f.selectable=!0),f.state=f.state||{},f.state.hasOwnProperty("checked")||(f.state.checked=!1),f.state.hasOwnProperty("disabled")||(f.state.disabled=!1),f.state.hasOwnProperty("expanded")||(!f.state.disabled&&c<e.options.levels&&f.nodes&&f.nodes.length>0?f.state.expanded=!0:f.state.expanded=!1),f.state.hasOwnProperty("selected")||(f.state.selected=!1),e.nodes.push(f),f.nodes&&e.setInitialStates(f,c)})}},g.prototype.clickHandler=function(b){this.options.enableLinks||b.preventDefault();var c=a(b.target),d=this.findNode(c);if(d&&!d.state.disabled){var e=c.attr("class")?c.attr("class").split(" "):[];e.indexOf("expand-icon")!==-1?(this.toggleExpandedState(d,f.options),this.render()):e.indexOf("check-icon")!==-1?(this.toggleCheckedState(d,f.options),this.render()):(d.selectable?this.toggleSelectedState(d,f.options):this.toggleExpandedState(d,f.options),this.render())}},g.prototype.findNode=function(a){var b=a.closest("li.list-group-item").attr("data-nodeid"),c=this.nodes[b];return c||console.log("Error: node does not exist"),c},g.prototype.toggleExpandedState=function(a,b){a&&this.setExpandedState(a,!a.state.expanded,b)},g.prototype.setExpandedState=function(b,c,d){c!==b.state.expanded&&(c&&b.nodes?(b.state.expanded=!0,d.silent||this.$element.trigger("nodeExpanded",a.extend(!0,{},b))):c||(b.state.expanded=!1,d.silent||this.$element.trigger("nodeCollapsed",a.extend(!0,{},b)),b.nodes&&!d.ignoreChildren&&a.each(b.nodes,a.proxy(function(a,b){this.setExpandedState(b,!1,d)},this))))},g.prototype.toggleSelectedState=function(a,b){a&&this.setSelectedState(a,!a.state.selected,b)},g.prototype.setSelectedState=function(b,c,d){c!==b.state.selected&&(c?(this.options.multiSelect||a.each(this.findNodes("true","g","state.selected"),a.proxy(function(a,b){this.setSelectedState(b,!1,d)},this)),b.state.selected=!0,d.silent||this.$element.trigger("nodeSelected",a.extend(!0,{},b))):(b.state.selected=!1,d.silent||this.$element.trigger("nodeUnselected",a.extend(!0,{},b))))},g.prototype.toggleCheckedState=function(a,b){a&&this.setCheckedState(a,!a.state.checked,b)},g.prototype.setCheckedState=function(b,c,d){c!==b.state.checked&&(c?(b.state.checked=!0,d.silent||this.$element.trigger("nodeChecked",a.extend(!0,{},b))):(b.state.checked=!1,d.silent||this.$element.trigger("nodeUnchecked",a.extend(!0,{},b))))},g.prototype.setDisabledState=function(b,c,d){c!==b.state.disabled&&(c?(b.state.disabled=!0,this.setExpandedState(b,!1,d),this.setSelectedState(b,!1,d),this.setCheckedState(b,!1,d),d.silent||this.$element.trigger("nodeDisabled",a.extend(!0,{},b))):(b.state.disabled=!1,d.silent||this.$element.trigger("nodeEnabled",a.extend(!0,{},b))))},g.prototype.render=function(){this.initialized||(this.$element.addClass(e),this.$wrapper=a(this.template.list),this.injectStyle(),this.initialized=!0),this.$element.empty().append(this.$wrapper.empty()),this.buildTree(this.tree,0)},g.prototype.buildTree=function(b,c){if(b){c+=1;var d=this;a.each(b,function(e,f){for(var g=a(d.template.item).addClass("node-"+d.elementId).addClass(f.state.checked?"node-checked":"").addClass(f.state.disabled?"node-disabled":"").addClass(f.state.selected?"node-selected":"").addClass(f.searchResult?"search-result":"").attr("data-nodeid",f.nodeId).attr("style",d.buildStyleOverride(f)),h=0;h<c-1;h++)g.append(d.template.indent);var i=[];if(f.nodes?(i.push("expand-icon"),f.state.expanded?i.push(d.options.collapseIcon):i.push(d.options.expandIcon)):i.push(d.options.emptyIcon),g.append(a(d.template.icon).addClass(i.join(" "))),d.options.showIcon){var i=["node-icon"];i.push(f.icon||d.options.nodeIcon),f.state.selected&&(i.pop(),i.push(f.selectedIcon||d.options.selectedIcon||f.icon||d.options.nodeIcon)),g.append(a(d.template.icon).addClass(i.join(" ")))}if(d.options.showCheckbox){var i=["check-icon"];f.state.checked?i.push(d.options.checkedIcon):i.push(d.options.uncheckedIcon),g.append(a(d.template.icon).addClass(i.join(" ")))}if(d.options.enableLinks?g.append(a(d.template.link).attr("href",f.href).append(f.text)):g.append(f.text),d.options.showTags&&f.tags&&a.each(f.tags,function(c,e){g.append(a(d.template.badge).append(e))}),d.$wrapper.append(g),f.nodes&&f.state.expanded&&!f.state.disabled)return d.buildTree(f.nodes,c)})}},g.prototype.buildStyleOverride=function(a){if(a.state.disabled)return"";var b=a.color,c=a.backColor;return this.options.highlightSelected&&a.state.selected&&(this.options.selectedColor&&(b=this.options.selectedColor),this.options.selectedBackColor&&(c=this.options.selectedBackColor)),this.options.highlightSearchResults&&a.searchResult&&!a.state.disabled&&(this.options.searchResultColor&&(b=this.options.searchResultColor),this.options.searchResultBackColor&&(c=this.options.searchResultBackColor)),"color:"+b+";background-color:"+c+";"},g.prototype.injectStyle=function(){this.options.injectStyle&&!c.getElementById(this.styleId)&&a('<style type="text/css" id="'+this.styleId+'"> '+this.buildStyle()+" </style>").appendTo("head")},g.prototype.buildStyle=function(){var a=".node-"+this.elementId+"{";return this.options.color&&(a+="color:"+this.options.color+";"),this.options.backColor&&(a+="background-color:"+this.options.backColor+";"),this.options.showBorder?this.options.borderColor&&(a+="border:1px solid "+this.options.borderColor+";"):a+="border:none;",a+="}",this.options.onhoverColor&&(a+=".node-"+this.elementId+":not(.node-disabled):hover{background-color:"+this.options.onhoverColor+";}"),this.css+a},g.prototype.template={list:'<ul class="list-group"></ul>',item:'<li class="list-group-item"></li>',indent:'<span class="indent"></span>',icon:'<span class="icon"></span>',link:'<a href="#" style="color:inherit;"></a>',badge:'<span class="badge"></span>'},g.prototype.css=".treeview .list-group-item{cursor:pointer}.treeview span.indent{margin-left:10px;margin-right:10px}.treeview span.icon{width:12px;margin-right:5px}.treeview .node-disabled{color:silver;cursor:not-allowed}",g.prototype.getNode=function(a){return this.nodes[a]},g.prototype.getParent=function(a){var b=this.identifyNode(a);return this.nodes[b.parentId]},g.prototype.getSiblings=function(a){var b=this.identifyNode(a),c=this.getParent(b),d=c?c.nodes:this.tree;return d.filter(function(a){return a.nodeId!==b.nodeId})},g.prototype.getSelected=function(){return this.findNodes("true","g","state.selected")},g.prototype.getUnselected=function(){return this.findNodes("false","g","state.selected")},g.prototype.getExpanded=function(){return this.findNodes("true","g","state.expanded")},g.prototype.getCollapsed=function(){return this.findNodes("false","g","state.expanded")},g.prototype.getChecked=function(){return this.findNodes("true","g","state.checked")},g.prototype.getUnchecked=function(){return this.findNodes("false","g","state.checked")},g.prototype.getDisabled=function(){return this.findNodes("true","g","state.disabled")},g.prototype.getEnabled=function(){return this.findNodes("false","g","state.disabled")},g.prototype.selectNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setSelectedState(a,!0,b)},this)),this.render()},g.prototype.unselectNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setSelectedState(a,!1,b)},this)),this.render()},g.prototype.toggleNodeSelected=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.toggleSelectedState(a,b)},this)),this.render()},g.prototype.collapseAll=function(b){var c=this.findNodes("true","g","state.expanded");this.forEachIdentifier(c,b,a.proxy(function(a,b){this.setExpandedState(a,!1,b)},this)),this.render()},g.prototype.collapseNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setExpandedState(a,!1,b)},this)),this.render()},g.prototype.expandAll=function(b){if(b=a.extend({},f.options,b),b&&b.levels)this.expandLevels(this.tree,b.levels,b);else{var c=this.findNodes("false","g","state.expanded");this.forEachIdentifier(c,b,a.proxy(function(a,b){this.setExpandedState(a,!0,b)},this))}this.render()},g.prototype.expandNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setExpandedState(a,!0,b),a.nodes&&b&&b.levels&&this.expandLevels(a.nodes,b.levels-1,b)},this)),this.render()},g.prototype.expandLevels=function(b,c,d){d=a.extend({},f.options,d),a.each(b,a.proxy(function(a,b){this.setExpandedState(b,c>0,d),b.nodes&&this.expandLevels(b.nodes,c-1,d)},this))},g.prototype.revealNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){for(var c=this.getParent(a);c;)this.setExpandedState(c,!0,b),c=this.getParent(c)},this)),this.render()},g.prototype.toggleNodeExpanded=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.toggleExpandedState(a,b)},this)),this.render()},g.prototype.checkAll=function(b){var c=this.findNodes("false","g","state.checked");this.forEachIdentifier(c,b,a.proxy(function(a,b){this.setCheckedState(a,!0,b)},this)),this.render()},g.prototype.checkNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setCheckedState(a,!0,b)},this)),this.render()},g.prototype.uncheckAll=function(b){var c=this.findNodes("true","g","state.checked");this.forEachIdentifier(c,b,a.proxy(function(a,b){this.setCheckedState(a,!1,b)},this)),this.render()},g.prototype.uncheckNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setCheckedState(a,!1,b)},this)),this.render()},g.prototype.toggleNodeChecked=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.toggleCheckedState(a,b)},this)),this.render()},g.prototype.disableAll=function(b){var c=this.findNodes("false","g","state.disabled");this.forEachIdentifier(c,b,a.proxy(function(a,b){this.setDisabledState(a,!0,b)},this)),this.render()},g.prototype.disableNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setDisabledState(a,!0,b)},this)),this.render()},g.prototype.enableAll=function(b){var c=this.findNodes("true","g","state.disabled");this.forEachIdentifier(c,b,a.proxy(function(a,b){this.setDisabledState(a,!1,b)},this)),this.render()},g.prototype.enableNode=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setDisabledState(a,!1,b)},this)),this.render()},g.prototype.toggleNodeDisabled=function(b,c){this.forEachIdentifier(b,c,a.proxy(function(a,b){this.setDisabledState(a,!a.state.disabled,b)},this)),this.render()},g.prototype.forEachIdentifier=function(b,c,d){c=a.extend({},f.options,c),b instanceof Array||(b=[b]),a.each(b,a.proxy(function(a,b){d(this.identifyNode(b),c)},this))},g.prototype.identifyNode=function(a){return"number"==typeof a?this.nodes[a]:a},g.prototype.search=function(b,c){c=a.extend({},f.searchOptions,c),this.clearSearch({render:!1});var d=[];if(b&&b.length>0){c.exactMatch&&(b="^"+b+"$");var e="g";c.ignoreCase&&(e+="i"),d=this.findNodes(b,e),a.each(d,function(a,b){b.searchResult=!0})}return c.revealResults?this.revealNode(d):this.render(),this.$element.trigger("searchComplete",a.extend(!0,{},d)),d},g.prototype.clearSearch=function(b){b=a.extend({},{render:!0},b);var c=a.each(this.findNodes("true","g","searchResult"),function(a,b){b.searchResult=!1});b.render&&this.render(),this.$element.trigger("searchCleared",a.extend(!0,{},c))},g.prototype.findNodes=function(b,c,d){c=c||"g",d=d||"text";var e=this;return a.grep(this.nodes,function(a){var f=e.getNodeValue(a,d);if("string"==typeof f)return f.match(new RegExp(b,c))})},g.prototype.getNodeValue=function(a,b){var c=b.indexOf(".");if(c>0){var e=a[b.substring(0,c)],f=b.substring(c+1,b.length);return this.getNodeValue(e,f)}return a.hasOwnProperty(b)?a[b].toString():d};var h=function(a){b.console&&b.console.error(a)};a.fn[e]=function(b,c){var d;return this.each(function(){var f=a.data(this,e);"string"==typeof b?f?a.isFunction(f[b])&&"_"!==b.charAt(0)?(c instanceof Array||(c=[c]),d=f[b].apply(f,c)):h("No such method : "+b):h("Not initialized, can not call method : "+b):"boolean"==typeof b?d=f:a.data(this,e,new g(this,a.extend(!0,{},b)))}),d||this}}(jQuery,window,document);</script>
  <style>.sidebar-nav li a,.sidebar-nav li a:active,.sidebar-nav li a:focus{text-decoration:none}body{overflow-x:hidden}#wrapper{padding-left:0;-webkit-transition:all .5s ease;-moz-transition:all .5s ease;-o-transition:all .5s ease;transition:all .5s ease}#wrapper.toggled{padding-left:250px}#sidebar-wrapper{z-index:99;position:fixed;left:250px;width:0;height:100%;margin-left:-250px;overflow-y:auto;background:#555;-webkit-transition:all .5s ease;-moz-transition:all .5s ease;-o-transition:all .5s ease;transition:all .5s ease}#wrapper.toggled #sidebar-wrapper{width:250px}#page-content-wrapper{width:100%;position:absolute;padding:15px}#wrapper.toggled #page-content-wrapper{position:absolute;margin-right:-250px}.sidebar-nav{position:absolute;top:0;width:250px;margin:0;padding:0;list-style:none}.sidebar-nav li{text-indent:20px;line-height:40px}.sidebar-nav li a{display:block;color:#999}.sidebar-nav li a:hover{text-decoration:none;color:#fff;background:rgba(255,255,255,.2)}.sidebar-nav>.sidebar-brand{height:65px;font-size:18px;line-height:60px}.sidebar-nav>.sidebar-brand a{color:#999}.sidebar-nav>.sidebar-brand a:hover{color:#fff;background:0 0}@media(min-width:768px){#wrapper{padding-left:250px}#wrapper.toggled{padding-left:0}#sidebar-wrapper{width:250px}#wrapper.toggled #sidebar-wrapper{width:0}#page-content-wrapper{padding:20px;position:relative}#wrapper.toggled #page-content-wrapper{position:relative;margin-right:0}}</style>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <style>
    .well {
      margin-bottom: 5px;
    }
    .col-sm-5, .col-sm-2 {
      padding-right: 5px;
      padding-left: 5px;
    }

    .node-folders {
      padding: 5px 10px;
    }

    .placeholder {
      border: 1px solid green;
      background-color: white;
      -webkit-box-shadow: 0px 0px 10px #888;
      -moz-box-shadow: 0px 0px 10px #888;
      box-shadow: 0px 0px 10px #888;
    }

    .draghandle {
      cursor: move;
    }
    .draghandle-v {
      cursor: ns-resize;
    }
    .folder-state-hover {
      background-color: #dff0d8;
      color: #3c763d;
      border-color: #d6e9c6;
    }

    .colorbox {
      display: inline-block;
      height: 13px;
      width: 13px;
      vertical-align: text-top;
    }
  </style>
</head>
<body>
  <div id="wrapper" class="toggled">
    <div id="sidebar-wrapper">
      <h3 style="color: white">&nbsp;&nbsp;Folders</h3>
      <div id="folders">
        Showing <span class="label label-info">0</span> flows in <span class="label label-info">0</span> folders</h1>
      </div>
    </div>
    <div id="page-content-wrapper">
      <div class=container-fluid>
        <h1>Homey flow viewer</h1>
        <div class="row">
          <div class="form-group col-sm-3">
            <a href="#menu-toggle" class="btn btn-default" id="menu-toggle">Toggle folders</a>
          </div>
          <div class="col-sm-9">
            <div class="form-group has-feedback">
              <input id="search" type="text" class="form-control" placeholder="Search" onKeyDown="search()" onKeyUp="search()" onChange="search()"/>
              <i class="glyphicon glyphicon-search form-control-feedback"></i>
            </div>
          </div>
        </div>

        <div id="flows"></div>
        <div class="hide">
          <div class="template_flow">
            <div class="panel panel-success" data="flow" data-flow-id="">
              <div class="panel-heading">
                <div class="row">
                  <div class="col-sm-4 draghandle" data="flow_path"></div>
                  <div class="col-sm-4 text-center">
                    <span class="text-muted" data="test_btn" data-toggle="tooltip" title="Test flow"><i class="fa fa-play"></i></span>
                    &nbsp;&nbsp;
                    <strong data="title"></strong>
                  </div>
                  <div class="col-sm-4 text-right">
                    <span class="label label-default" data="label_disabled"></span>
                    <span class="label label-danger" data="label_broken"></span>
                    <button class="btn btn-default" data="toggle_btn" data-toggle="tooltip" title="Enable or disable"><i class="fa fa-square-o"></i></button>
                    <button class="btn btn-default" data="edit_btn"   data-toggle="tooltip" title="Rename & Move"><i class="fa fa-pencil"></i></button>
                    <button class="btn btn-default" data="copy_btn"   data-toggle="tooltip" title="Copy"><i class="fa fa-clone"></i></button>
                    <button class="btn btn-default" data="delete_btn" data-toggle="tooltip" title="Delete"><i class="fa fa-remove"></i></button>
                  </div>
                </div>
              </div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-sm-2 small">
                    <div class="text-muted">Trigger</div>
                    <span data="cards_trigger"/>
                  </div>
                  <div class="col-sm-5 small">
                    <div class="text-muted">Conditions</div>
                    <span data="cards_condition"/>
                  </div>
                  <div class="col-sm-5 small">
                    <div class="text-muted">Actions</div>
                    <span data="cards_action"/>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="template_card">
            <div data="card" class="card">
              <div class="well well-sm">
                <span class="label label-danger" data="label_danger"></span>
                <span class="label label-success pull-right" data="card_type_device"></span>
                <span class="label label-info pull-right" data="card_type_app"></span>
                <span class="label label-primary pull-right" data="card_type_manager"></span>
                <span class="text-muted draghandle-v" data="move_card_btn"><i class="fa fa-arrows"></i></span>&nbsp;
                <!-- <span class="text-muted" data="edit_card_btn" data-toggle="tooltip" title="Edit"><i class="fa fa-pencil"></i></span>&nbsp; -->
                <span class="text-muted" data="test_card_btn" data-toggle="tooltip" title="Test"><i class="fa fa-play"></i></span>
                &nbsp;&nbsp;
                <span class="text-nowrap"><strong data="card_title"></strong></span><br>
                <span class="text-muted" data="card_args"></span>
                <span class="text-muted" data="card_delay"></span>
                <span class="text-muted" data="card_droptoken"></span>
              </div>
            </div>
          </div>

          <div class="dialog_copy form-group">
            <label for="copyName">New name</label>
            <input id="copyName" class="form-control" type="text"  value="">
            <label for="copyFolder">Copy to folder</label>
            <select id="copyFolder" class="form-control">
              <option value="false">None</option>
            </select>
          </div>

          <div class="dialog_edit form-group">
            <label for="editName">Name</label>
            <input id="editName" class="form-control" type="text"  value="">
            <label for="editFolder">Folder</label>
            <select id="editFolder" class="form-control">
              <option value="false">None</option>
            </select>
          </div>

          <div class="dialog_test form-group">
            <span class="text-muted" data="Progress:"></span>
            <span class="text-muted" data="test_status">initializing...</span>
          </div>
          <!-- <div class="dialog_edit_card form-group">
            <label for="delay">Delay</label>
            <input id="delay" class="form-control" type="text"  value="">
            <div class="arguments"></div>
          </div>

          <div class="dialog_edit_card_argument text form-group">
            <label for="field"></label>
            <input id="field" class="form-control" type="text"  value="">
          </div>

          <div class="dialog_edit_card_argument text form-group">
            <label for="field"></label>
            <input id="field" class="form-control" type="number"  value="">
          </div> -->
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="text-muted">flows: <span id=flow_count>loading...</span></p>
      </div>
    </footer>
  </div>
  <script>
  var devices = []
  var cards
  var folders = []
  var flows = []

  if (setup.ip === '0.0.0.0') alert('Configure your Homey IP in this script...')
  if (setup.bearer_token === 'your token') alert('Configure your Bearer token in this script...')

  $.ajaxSetup({
    contentType : 'application/json',
    headers: {Authorization: 'Bearer ' + setup.bearer_token}
  })

  jQuery.expr[':'].icontains = jQuery.expr.createPseudo(function (arg) {
    return function (elem) {
      return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0
    }
  })

  String.prototype.capitalizeFirstLetter = function() {
      return this.charAt(0).toUpperCase() + this.slice(1)
  }

  function addFlow (flow) {
    var newFlow = $('.template_flow').clone()
    $(newFlow).find('[data=flow]').attr('data-flow-id', flow.id)
    $(newFlow).find('[data=title]').html(`<a href="${setup.protocol}://${setup.ip}/manager/flow/#${flow.id}" target=_new>${flow.title}</a>`)
    $(newFlow).find('[data=cards_trigger]').append(formatCard(flow.id, flow.trigger, 'trigger', 0).html())
    $(newFlow).find('[data=cards_condition]').append(formatCards(flow, 'conditions').html())
    $(newFlow).find('[data=cards_action]').append(formatCards(flow, 'actions').html())
    $(newFlow).find('[data=toggle_btn]').attr('onClick', `toggleFlow('${flow.id}')`)
    $(newFlow).find('[data=edit_btn]').attr('onClick', `editFlow('${flow.id}')`)
    $(newFlow).find('[data=copy_btn]').attr('onClick', `copyFlow('${flow.id}')`)
    $(newFlow).find('[data=delete_btn]').attr('onClick', `deleteFlow('${flow.id}')`)
    $(newFlow).find('[data=test_btn]').attr('onClick', `testFlow('${flow.id}')`)
    $(newFlow).find('[data=flow_path]').html('<i class="fa fa-folder-open" aria-hidden="true"></i> ' + (flow.folder ? formatFolder(flow.folder) : ''))
    if (flow.broken) {
      $(newFlow).find('[data=flow]').removeClass("panel-success").addClass("panel-danger")
      $(newFlow).find('[data=label_broken]').html("BROKEN")
    }
    $('#flows').append(newFlow.html())
    showFlowToggleButton(flow.id)
  }

  function noCard () {
    var noCard = $('<div />')
    noCard.html('<br><span class="label label-danger">NO CARD</span>')
    return noCard
  }

  function formatCards (flow, type) {
    if (type === 'actions' && flow[type].length === 0) return noCard()
    var newCards = $("<div />")
    flow[type].forEach(function (card, index) {
      newCards.append(formatCard(flow.id, card, type, index).html())
    })
    return newCards
  }

  function formatCard (flowId, card, type, index) {
    if (isEmptyObject(card)) return noCard()
    var newCard = $('.template_card').clone()
    var definitions = getCard(card.uri, (type === 'trigger') ? type : type.slice(0, -1), card.id)
    var app = getApp(card.uri)

    $(newCard).find('[data=card]').attr('card_index', index)
    if (type === 'conditions') {
      $(newCard).find('[data=card_title]').html(conditionTitleParse(definitions.title.en, !card.inverted))
    } else {
      $(newCard).find('[data=card_title]').html(definitions.title.en)
    }

    $(newCard).find('[data=card_type_' + app.uriObj.type + ']').html(app.uriObj.name)
    if (!isEmptyObject(card.args)) $(newCard).find('[data=card_args]').html(formatArgs(card, definitions))
    if (card.delay && card.delay.number !== '0') $(newCard).find('[data=card_delay]').html('<i>delay</i>: ' + card.delay.number + (card.delay.multiplier === '60' ? ' minute' : ' second') + (card.delay.number !== '1' ? 's' : ''))
    if (card.droptoken) $(newCard).find('[data=card_droptoken]').html('<i>token</i>: <code>' + (card.droptoken) + '</code>')
    if (definitions.tokens) {
      var tokens = '<i>tokens</i>: '
      definitions.tokens.forEach(token => {
        tokens += '<code>' + (token.name) + '</code> '
      })
      $(newCard).find('[data=card_droptoken]').html(tokens)
    }
    if (type === 'trigger') $(newCard).find('[data=move_card_btn], [data=test_card_btn]').remove()
    $(newCard).find('[data=test_card_btn]').attr('onClick', `testCard('${flowId}','${type}',${index})`)
    return newCard
  }

  function formatFolder (id) {
    var result = getFolder(id).title
    if (getFolder(id).folder) result = formatFolder(getFolder(id).folder) + " > " + result
    return result
  }

  function formatArgs (card, definitions) {
    var output = ''
    Object.keys(card.args).forEach(function (argument) {
      if (Object.prototype.toString.call(definitions.args) === '[object Object]') definitions.args = [definitions.args]
      output += '<i>' + argument + '</i>: ' + formatArgValue(definitions.args.filter(item => item.name === argument)[0], card.args[argument]) + '<br>'
    })
    output = output.replace(/\[\[/g, '<code>').replace(/]\]/g, '</code>')
    return output
  }

  function formatArgValue (argDef, value) {
    switch (argDef.type) {
      case 'autocomplete':
        return value.name
      case 'dropdown':
        console.log(argDef, value)
        console.log(argDef.values.filter(item => item.id.toString() === value.toString()))
        return argDef.values.filter(item => item.id.toString() === value.toString())[0].label.en
      case 'color':
        return `<span class="colorbox" style="background-color: ${value}"> </span> (${value})`
      case 'range':
        return value * (argDef.labelMultiplier || 1) + (argDef.label || '')
      case 'text':
      case 'number':
      case 'time':
        return value
      default:
        console.log(argDef, value)
        return value
    }
  }

  function isEmptyObject (obj) {
    return Object.getOwnPropertyNames(obj).length === 0
  }

  function conditionTitleParse (e, t) {
    var a = e.match(/\!\{\{(.*?)\}\}/g)
    if (a === null) return e
    a.forEach(function(a) {
      var n = a
      if('!' == a.charAt(0)) a = a.substring(1)
      e = e.replace(n, a.replace('{{', '').replace('}}', '').split('|')[t ? 0 : 1] || '')
    })
    return e
  }

  function getApp (uri) {
    return cards.filter(app => app.uri === uri)[0]
  }

  function getCard (uri, type, id) {
    return getApp(uri).cards[type].filter(card => card.id === id)[0]
  }

  function getDevice (id) {
    return devices.filter(device => device.id === id)[0]
  }

  function getFlow (id) {
    return flows.filter(flow => flow.id === id)[0]
  }

  function getFolder (id) {
    return folders.filter(folder => folder.id === id)[0]
  }

  function loadCards (callback) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/card/`, function(data) {
      cards = data.result
      callback()
    })
  }

  function loadDevices (callback) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/devices/device/`, function(data) {
      $.each(data.result, function (index, resultDevice) {
        devices.push({id: resultDevice.id, name: resultDevice.name})
      })
      callback()
    })
  }

  function loadFlows (callback) {
    // get all flow folders
    flows = []
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/`, function(data) {
      $.each(data.result, function (index, flow) {
        flows.push(flow)
      })
      callback()
    })
  }

  function loadFolders (callback) {
    folders = []
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/folder/`, function(data) {
      $.each(data.result, function (index, folder) {
        folders.push(folder)
      })
      sortFolders()
      callback()
    })
  }

  function folderOrder (id) {
    var order = formatOrderNumber(getFolder(id).order) + '|'
    if (getFolder(id).folder) order = folderOrder(getFolder(id).folder) + order
    return order
  }

  function formatOrderNumber (order) {
    return ('00000' + order).slice(-5)
  }

  function sortFolders () {
    folders.forEach(folder => {
      folder.sorting = folderOrder(folder.id)
    })
    folders.sort((a, b) => (a.sorting > b.sorting ? 1 : -1))
  }

  function showFlows (callback) {
    flows.forEach(flow => {
      flow.order = formatOrderNumber(flow.order)
      if (flow.folder) flow.order = folderOrder(flow.folder) + flow.order
    })
    flows.sort((a, b) => (a.order > b.order ? 1 : -1))
    flows.forEach(flow => {
      addFlow(flow)
    })
    callback()
  }

  $.getScript(`${setup.protocol}://${setup.ip}/socket.io/socket.io.js`, () => {
    loadDevices(() => {
      loadFolders(() => {
        loadCards(() => {
          loadFlows(() => {
            showFlows(() => {
              setTimeout(ready, 1000)
            })
          })
        })
      })
    })
  })
  function ready() {
    $('#flow_count').html(flows.length)
    $('#folders').treeview({
      data: getTree(),
      expandIcon: 'glyphicon glyphicon-chevron-right',
      collapseIcon: 'glyphicon glyphicon-chevron-down',
      showTags: true,
      onNodeSelected: function(event, node) {
        $('[data=flow]').hide()
        flows.filter(flow => flow.folder === node.id).forEach(flow => {
          $(`[data-flow-id=${flow.id}]`).show()
        })
        setTimeout(setFoldersDroppable, 500)
      },
      onNodeUnselected: function (event, node) {
        $('#flows [data=flow]').show()
        setTimeout(setFoldersDroppable, 500)
      }
    })
    $("#wrapper").toggleClass("toggled")
    setTooltips()
    setFlowsDraggable()
    setFoldersDroppable()
    setFlowCardsSortable()
  }

  function copyFlow (flowId) {
    copyFlowDialog(flowId, function(newName, newFolder) {
      if (newName) {
        if (newFolder === 'false') newFolder = false
        $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
          if (data.status !== 200) return alert('Copy failure... getting existing flow')
          var existingFlow = data.result
          $.post(`${setup.protocol}://${setup.ip}/api/manager/flow/flow`, function(data) {
            if (data.status !== 200) return alert('Copy failure... requesting new id')
            var newFlow = existingFlow
            newFlow.id = data.result.id
            newFlow.title = newName
            newFlow.folder = newFolder
            newFlow.order = data.result.order
            $.ajax({
              url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${newFlow.id}`,
              type: 'PUT',
              data: JSON.stringify(newFlow),
              success: function(data) {
                location.reload()
              }
            })
          })
        })
      }
    })
  }

  function deleteFlow (flowId) {
    deleteFlowDialog(flowId, function(doDelete) {
      if (!doDelete) return
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
        type: 'DELETE',
        success: function(data) {
          $(`[data-flow-id=${flowId}]`).slideUp(1000)
        }
      })
    })
  }

  function showFlowToggleButton (flowId) {
    if (getFlow(flowId).enabled) {
      $(`[data-flow-id=${flowId}] [data=label_disabled]`).html("")
      $(`[data-flow-id=${flowId}] [data=toggle_btn] i`).removeClass('fa-square-o').addClass('fa-check-square-o')
      if (!getFlow(flowId).broken) {
        $(`[data-flow-id=${flowId}]`).removeClass("panel-default").addClass("panel-success")
      }
    } else {
      $(`[data-flow-id=${flowId}] [data=label_disabled]`).html("DISABLED")
      $(`[data-flow-id=${flowId}] [data=toggle_btn] i`).removeClass('fa-check-square-o').addClass('fa-square-o')
      if (!getFlow(flowId).broken) {
        $(`[data-flow-id=${flowId}]`).removeClass("panel-success").addClass("panel-default")
      }
    }
  }

  function updateFlowFolder (flowId, folderId) {
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
      if (data.status !== 200) return alert('Save failure... getting existing flow')
      var existingFlow = data.result

      existingFlow.folder = folderId
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
        type: 'PUT',
        data: JSON.stringify(existingFlow),
        success: function(data) {
          location.reload()
        }
      })
    })
  }

  function editFlow (flowId) {
    editFlowDialog(flowId, function(newName, newFolder) {
      if (newName) {
        if (newFolder === 'false') newFolder = false
        $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
          if (data.status !== 200) return alert('Edit failure... getting existing flow')
          var existingFlow = data.result
          existingFlow.title = newName
          existingFlow.folder = newFolder
          $.ajax({
            url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
            type: 'PUT',
            data: JSON.stringify(existingFlow),
            success: function(data) {
              location.reload()
            }
          })
        })
      }
    })
  }

  function toggleFlow (flowId) {
    flows.filter(flow => flow.id === flowId)[0].enabled = !getFlow(flowId).enabled
    $.ajax({
      url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
      type: 'PUT',
      data: JSON.stringify({enabled: getFlow(flowId).enabled}),
      success: function(data) {
        showFlowToggleButton(flowId)
      }
    })
  }

  function copyFlowDialog (flowId, callback) {
    var message = $('.dialog_copy').clone()
    $(message).find('[id=copyName]').attr('value', `${getFlow(flowId).title} (copy)`)
    folders.forEach(folder => {
      $(message).find('[id=copyFolder]').append($("<option></option>").attr("value", folder.id).text(formatFolder(folder.id)))
    })
    $(message).find('[id=copyFolder]').val(getFlow(flowId).folder.toString())
    BootstrapDialog.show({
      title: 'Copy flow',
      message: message,
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Copy',
          action: function (dialogRef) {
            var newName = dialogRef.getModalBody().find('[id=copyName]').val()
            var newFolder = dialogRef.getModalBody().find('[id=copyFolder]').val()
            dialogRef.close()
            callback(newName, newFolder)
          }
        }
      ]
    })
  }

  function deleteFlowDialog (flowId, callback) {
    BootstrapDialog.show({
      title: 'Delete flow',
      message: 'Are you sure you want to delete flow ' + getFlow(flowId).title + '?',
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Delete',
          action: function (dialogRef) {
            dialogRef.close()
            callback(true)
          }
        }
      ]
    })
  }

  function editFlowDialog (flowId, callback) {
    var message = $('.dialog_edit').clone()
    $(message).find('[id=editName]').attr('value', `${getFlow(flowId).title}`)
    folders.forEach(folder => {
      $(message).find('[id=editFolder]').append($("<option></option>").attr("value", folder.id).text(formatFolder(folder.id)))
    })
    $(message).find('[id=editFolder]').val(getFlow(flowId).folder.toString())
    BootstrapDialog.show({
      title: 'Edit and move flow',
      message: message,
      buttons: [
        {
          label: 'Cancel',
          action: function (dialogRef) {
            dialogRef.close()
            callback(false)
          }
        },{
          label: 'Save',
          action: function (dialogRef) {
            var editName = dialogRef.getModalBody().find('[id=editName]').val()
            var editFolder = dialogRef.getModalBody().find('[id=editFolder]').val()
            dialogRef.close()
            callback(editName, editFolder)
          }
        }
      ]
    })
  }

  function testDialog () {
    var message = $('.dialog_test').clone()
    $(message).find('[id=test_status]').html('xxxx')
    return BootstrapDialog.show({
      title: 'Testing',
      message: message,
      closable: false,
      onshow: function (dialogRef) {
        dialogRef.enableButtons(false)
        dialogRef.getButton('close').spin()
      },
      buttons: [
        {
          id: 'close',
          label: 'Close',
          action: function (dialogRef) {
            dialogRef.close()
          }
        }
      ]
    })
  }

  function orderArrayByIndexMap (array, indexMap) {
    var result = []
    indexMap.forEach((order, index) => result[index] = array[order])
    return result
  }

  function indexMapHasChanged (indexMap) {
    var result = false
    indexMap.forEach((order, index) => {if (order !== index) { result = true }})
    return result
  }

  function saveFlowCardOrder (flowId, conditionsOrder, actionsOrder) {
    if (!(indexMapHasChanged(conditionsOrder) || indexMapHasChanged(actionsOrder))) return
    $.getJSON(`${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`, function(data) {
      if (data.status !== 200) return alert('Failure... getting existing flow')
      var existingFlow = data.result
      existingFlow.conditions = orderArrayByIndexMap(existingFlow.conditions, conditionsOrder)
      existingFlow.actions = orderArrayByIndexMap(existingFlow.actions, actionsOrder)
      getFlow(flowId).conditions = existingFlow.conditions
      getFlow(flowId).actions = existingFlow.actions
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/${flowId}`,
        type: 'PUT',
        data: JSON.stringify(existingFlow),
        success: function(data) {
          // reset order
          console.log('order saved')
          // location.reload()
        }
      })
    })
  }

  function search () {
    value = $('[id=search]').val()
    $('[data=flow]').hide()
    $(`:icontains(${value})`).parents('#flows [data=flow]').show()
  }
  var dialog
  function test (flowId, testFlow, testCardIndex) {
    dialog = testDialog()
    var socket = io.connect(`${setup.protocol}://${setup.ip}/realtime/manager/flow/`, {query: `token=${setup.bearer_token}`, transports: ['websocket', 'polling']})
    var session
    var cards = {total: testFlow.flow.conditions.length + testFlow.flow.actions.length, running: 0, passed: 0, failed: 0, error: 0, errors: []}
    socket.on('test', function (data) {
      if (data.test_id !== session) return
      cards[data.state] += 1
      if (data.state === 'running') {
        $(`[data-flow-id=${flowId}] [data=cards_${data.card_type}] .well`).eq(testCardIndex || data.card_index).css('background-color', 'lightblue')
      }
      if (data.state === 'passed') {
        cards.running -= 1
        $(`[data-flow-id=${flowId}] [data=cards_${data.card_type}] .well`).eq(testCardIndex || data.card_index).css('background-color', 'lightgreen').animate({'background-color': '#f5f5f5'}, 1500)
      }
      if (data.state === 'failed' || data.state === 'error') {
        cards.running -= 1
        $(`[data-flow-id=${flowId}] [data=cards_${data.card_type}] .well`).eq(testCardIndex || data.card_index).css('background-color', 'red').animate({'background-color': '#f5f5f5'}, 3000)
        if (data.state === 'error') cards.errors.push(data.err)
        socket.close()
        dialog.setClosable(true)
        dialog.updateButtons()
      }
      dialog.$modalDialog.find('[data=test_status]').html(JSON.stringify(cards, null, 2))
      if (cards.total === cards.passed) {
        socket.close()
        dialog.setClosable(true)
        dialog.updateButtons()
      }
    })
    socket.on('connect', function () {
      $.ajax({
        url: `${setup.protocol}://${setup.ip}/api/manager/flow/flow/test/`,
        type: 'POST',
        data: JSON.stringify(testFlow),
        success: function(data) {
          session = data.result
        }
      })
    })
  }

  function testCard (flowId, type, index) {
    var testflow = {
      "flow":{
        "trigger":{},
        "conditions":[],
        "actions":[]
      },
      "tokens":{}
    }

    if (!isEmptyObject(getFlow(flowId).trigger)) {
      (getCard(getFlow(flowId).trigger.uri, 'trigger', getFlow(flowId).trigger.id).tokens || []).forEach(token => {
        if ((token.type || 'string').toLowerCase() === 'string') {
          testflow.tokens[token.name] = token.example.en
        } else {
          testflow.tokens[token.name] = token.example
        }
      })
    }

    testflow.flow[type].push(getFlow(flowId)[type][index])
    test(flowId, testflow, index)
  }

  function testFlow (flowId) {
    var testflow = {
      "flow":{
        "trigger":{},
        "conditions":[],
        "actions":[]
      },
      "tokens":{}
    }

    if (!isEmptyObject(getFlow(flowId).trigger)) {
      (getCard(getFlow(flowId).trigger.uri, 'trigger', getFlow(flowId).trigger.id).tokens || []).forEach(token => {
        if ((token.type || 'string').toLowerCase() === 'string') {
          testflow.tokens[token.name] = token.example.en
        } else {
          testflow.tokens[token.name] = token.example
        }
      })
    }

    testflow.flow.conditions =  getFlow(flowId).conditions
    testflow.flow.actions = getFlow(flowId).actions
    if (testflow.flow.conditions.length + testflow.flow.actions.length > 0) test(flowId, testflow, null)
  }

  function getTree() {
    function treeBuild (parent) {
      var tree = []
      for (var folderIndex in folders) {
        var folder = folders[folderIndex]
        if (folder.folder == parent) {
          var node = {text: folder.title, nodes: treeBuild(folder.id), order: folder.order, id: folder.id}
          if (node.nodes.length === 0) delete node.nodes
          var flowCount = flows.filter(flow => flow.folder === folder.id).length
          if (flowCount > 0) node.tags = [flowCount]
          tree.push(node)
        }
      }
      return tree.sort(function (a, b) { return a.order > b.order ? 1 : -1})
    }
    return treeBuild(false)
  }

  function setFlowsDraggable() {
    $('#flows [data=flow]').draggable({
      handle: '[data=flow_path]',
      zIndex: 100,
      revert: true,
      start: function (event, ui) {
        if ($("#wrapper").hasClass("toggled")) $("#wrapper").toggleClass("toggled")
      }
    })
  }

  function orderFlowView () {
    var list = $('#flows [data=flow]')
    list.sort((a, b) => {
      return (getFlow($(a).data('flow-id')).order > (getFlow($(b).data('flow-id')).order) ? 1 : -1)
    })
    $("#flows").html(list)
    setFlowsDraggable()
    setFlowCardsSortable()
    setTooltips()
  }


  function setFoldersDroppable () {
    $('#folders li').droppable({
      accept: '[data=flow]',
      tolerance: 'pointer',
      classes: {
        'ui-droppable-hover': 'folder-state-hover'
      },
      drop: function (event, ui) {
        var flowId = $(event.toElement).parents('[data=flow]').attr('data-flow-id')
        var folderId = $('#folders').treeview('getNode', $(event.target).attr('data-nodeid')).id
        updateFlowFolder(flowId, folderId)
      }
    })
  }

  function setFlowCardsSortable() {
    $('[data=cards_action], [data=cards_condition]').sortable({
      handle: '[data=move_card_btn]',
      tolerance: 'pointer',
      revert: 'invalid',
      placeholder: 'placeholder well well-sm',
      forceHelperSize: true,
      start: function(event, ui) {
        ui.placeholder.height(ui.item.find('.well').height())
      },
      stop: function (event, ui) {
        var flowId = ui.item.parents('[data=flow]').attr('data-flow-id')
        var actionsOrder = []
        var conditionsOrder = []
        $(`[data-flow-id=${flowId}] [data=cards_condition] .card`).each(function (card) { conditionsOrder.push($(this).attr('card_index') * 1); $(this).attr('card_index', card) } )
        $(`[data-flow-id=${flowId}] [data=cards_action] .card`).each(function (card) { actionsOrder.push($(this).attr('card_index') * 1); $(this).attr('card_index', card) } )
        saveFlowCardOrder(flowId, conditionsOrder, actionsOrder)
      }
    })
  }

  function setTooltips() { $('[data-toggle="tooltip"]').tooltip() }

  $("#menu-toggle").click(function (e) {
    e.preventDefault()
    $("#wrapper").toggleClass("toggled")
   })
</script>
</body>
</html>
